name: Slack Notifications for Label, Mentions, and Review Requests

on:
  issues:
    types: [labeled, unlabeled]
  pull_request:
    types: [labeled, unlabeled, review_requested]
  issue_comment:
    types: [created]

jobs:
  notify_label:
    if: github.event_name == 'issues' || (github.event_name == 'pull_request' && (github.event.action == 'labeled' || github.event.action == 'unlabeled'))
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack alert for label added or removed
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: >-
            {"text":":label: *Label ${{ github.event.action == 'labeled' && 'added' || github.event.action == 'unlabeled' && 'removed' }}* on PR: *${{ github.event.issue.title || github.event.pull_request.title }}* by `${{ github.actor }}`\n• Label: `${{ github.event.label.name }}`\n<${{ github.event.issue.html_url || github.event.pull_request.html_url }}|View on GitHub>"}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  notify_review_requested:
    if: github.event_name == 'pull_request' && github.event.action == 'review_requested'
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack alert for review request
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: >-
            {"text":":eyes: *Review requested* on PR: *${{ github.event.pull_request.title }}*\n• By: `${{ github.actor }}`\n• Reviewer: `${{ github.event.requested_reviewer.login }}`\n<${{ github.event.pull_request.html_url }}|View PR>"}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  notify_mention:
    if: github.event_name == 'issue_comment' && contains(github.event.comment.body, '@')
    runs-on: ubuntu-latest
    steps:
      - name: Set up jq and generate Slack payload
        run: |
          mkdir -p tmp
          jq -n \
            --arg title "${{ github.event.issue.title || github.event.pull_request.title }}" \
            --arg actor "${{ github.actor }}" \
            --arg body "${{ github.event.comment.body }}" \
            --arg url "${{ github.event.comment.html_url }}" \
            '{
              text: ":speech_balloon: *Comment with Mention* on PR: *\($title)*\n• By: `\($actor)`\n> \($body)\n<\($url)|View Comment>"
            }' > tmp/payload.json
        
      - name: Send Slack alert with safe payload
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload-file-path: tmp/payload.json
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}